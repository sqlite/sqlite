# 2025-12-15
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
# 

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix bestindexF

ifcapable !vtab {
  finish_test
  return
}


proc vtab_command {method args} {
  switch -- $method {
    xConnect {
      return "CREATE TABLE t1(a, b, c)"
    }

    xBestIndex {
      set hdl [lindex $args 0]
      set ::vtab_orderby [$hdl orderby]
      set ::vtab_distinct [$hdl distinct]

      if {$::vtab_orderby == "{column 0 desc 0} {column 1 desc 0}"
       || $::vtab_orderby == "{column 0 desc 0}"
      } {
        return [list orderby 1]
      }

      return ""
    }

    xFilter {
      set sql {
        SELECT 1, 1, 'a', 555
          UNION ALL
        SELECT 2, 1, 'a', NULL
          UNION ALL
        SELECT 3, 1, 'b', 'text'
          UNION ALL
        SELECT 4, 2, 'a', 3.14
          UNION ALL
        SELECT 5, 2, 'b', 0
      }
      return [list sql $sql]
    }
  }

  return {}
}

register_tcl_module db

do_execsql_test 1.0 {
  CREATE VIRTUAL TABLE t1 USING tcl(vtab_command)
}

proc uses_idxinsert {sql} {
  return [expr [lsearch [db eval "explain $sql"] IdxInsert]>=0]
}
proc do_idxinsert_test {tn sql res} {
  set uses [uses_idxinsert $sql]
  uplevel [list do_execsql_test $tn "SELECT $uses ; $sql" $res]
}

do_idxinsert_test 1.1.1 {
  SELECT DISTINCT a, b FROM t1 
} {0    1 a 1 b 2 a 2 b}

do_test 1.1.2 {
  list $::vtab_distinct $::vtab_orderby
} {2 {{column 0 desc 0} {column 1 desc 0}}}

do_execsql_test 1.3 {
  CREATE TABLE t0(c0);
  INSERT INTO t0 VALUES(0);
  INSERT INTO t0 VALUES(1);
}

do_idxinsert_test 1.4.1 {
  SELECT DISTINCT t0.c0 FROM t1, t0 ORDER BY t1.a;
} {1    0 1}
do_test 1.4.2 {
  list $::vtab_distinct $::vtab_orderby
} {0 {{column 0 desc 0}}}

finish_test
