# 2023 January 12
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix concurrentA

do_execsql_test 1.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b);
  INSERT INTO t1 VALUES(1, 'one');
  INSERT INTO t1 VALUES(2, 'two');
  INSERT INTO t1 VALUES(3, 'three');
  INSERT INTO t1 VALUES(4, 'four');
  INSERT INTO t1 VALUES(5, 'five');
} {wal}

do_execsql_test 1.1 {
  BEGIN CONCURRENT;
    SELECT * FROM t1 WHERE x=4;
} {4 four}

do_execsql_test 1.2 {
    INSERT INTO t1 VALUES(6, 'six');
}

do_execsql_test 1.3 {
  SELECT * FROM sqlite_conc;
} {
  2 read   5  6
  2 read   4  4
  2 insert 6 (NULL,'six')
}

do_execsql_test 1.4 {
  COMMIT;
}

do_execsql_test 2.0 {
  BEGIN CONCURRENT;
    UPDATE t1 SET b='four+1' WHERE x=4;
    DELETE FROM t1 WHERE x=1;
}

sqlite3 db2 test.db
do_execsql_test -db db2 2.1 {
  BEGIN CONCURRENT;
    UPDATE t1 SET b='two+1' WHERE x=2;
  COMMIT;
}

do_execsql_test 2.2 {
  COMMIT;
  SELECT * FROM t1;
} {
  2 two+1 3 three 4 four+1 5 five 6 six
}

do_execsql_test 2.3 {
  BEGIN CONCURRENT;
    UPDATE t1 SET b='three+1' WHERE x=3;
    SELECT * FROM t1 WHERE x=6;
} {6 six}

do_execsql_test -db db2 2.4 {
  BEGIN CONCURRENT;
    UPDATE t1 SET b='six+1' WHERE x=6;
  COMMIT;
}

do_catchsql_test 2.5 {
  COMMIT
} {1 {database is locked}}

#--------------------------------------------------------------------------
reset_db

do_execsql_test 3.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b);
  INSERT INTO t1 VALUES(2, 'two');
  INSERT INTO t1 VALUES(4, 'four');
  INSERT INTO t1 VALUES(6, 'six');
  INSERT INTO t1 VALUES(8, 'eight');
  INSERT INTO t1 VALUES(10, 'ten');
  INSERT INTO t1 VALUES(12, 'twelve');
  INSERT INTO t1 VALUES(14, 'fourteen');
  INSERT INTO t1 VALUES(16, 'sixteen');
  INSERT INTO t1 VALUES(18, 'eightteen');
  INSERT INTO t1 VALUES(20, 'twenty');
} {wal}

set START -9223372036854775808
set END    9223372036854775807
foreach {tn sql range} {
  1 { SELECT * FROM t1 }                         {$START $END}
  2 { SELECT * FROM t1 WHERE x BETWEEN 4 AND 8 } {4 10}
  3 { SELECT * FROM t1 WHERE x BETWEEN 4 AND 7 } {4 8}
  4 { SELECT * FROM t1 WHERE x = 4 }             {4 4}
  5 { SELECT * FROM t1 WHERE x = 5 }             {5 6}
  6 { SELECT * FROM t1 WHERE x > 6 }             {6 $END}
  7 { SELECT * FROM t1 WHERE x > 5 }             {5 $END}
  8 { SELECT max(x) FROM t1 }                    {20 $END}
  9 { SELECT min(x) FROM t1 }                    {$START 2}
  10 { INSERT INTO t1 VALUES(NULL, NULL) }       {20 21  20 $END}

  11 { SELECT * FROM t1 WHERE x < 6 ORDER BY x DESC} {$START 6}
} {

  set lRes [list]
  foreach {a b} [subst $range] { lappend lRes 2 read $a $b }

  execsql "BEGIN CONCURRENT"
  execsql $sql
  do_execsql_test 3.1.$tn {
    SELECT * FROM sqlite_conc WHERE op='read'
  } $lRes

  execsql ROLLBACK
}

db close
sqlite3 db test.db
sqlite3 db2 test.db

do_test 3.2 {
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='six+1' WHERE x=6;
    COMMIT;
  }
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='ten+1' WHERE x=10;
      SELECT * FROM t1 WHERE x=6;
  } 
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='sixteen+1' WHERE x=16;
    COMMIT;
  } db2
  execsql {
    COMMIT
  }
} {}
do_test 3.3 {
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='four+1' WHERE x=4;
  }
  execsql {
    UPDATE t1 SET b='four+2' WHERE x=4;
  } db2
  catchsql {
    COMMIT
  }
} {1 {database is locked}}
execsql { ROLLBACK }

do_test 3.4 {
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='four+3' WHERE x=4;
  }
  execsql {
    BEGIN CONCURRENT;
      UPDATE t1 SET b='four+4' WHERE x=4;
    COMMIT;
  } db2
  catchsql {
    COMMIT
  }
} {1 {database is locked}}
execsql { ROLLBACK }

#-------------------------------------------------------------------------
reset_db
do_execsql_test 4.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(x INTEGER PRIMARY KEY, y INTEGER);
  INSERT INTO t1 VALUES(1, 10), (2, 20), (3, 30), (4, 40), (5, 50);
  INSERT INTO t1 VALUES(6, 60), (7, 70), (8, 80), (9, 90), (10, 100);
  CREATE INDEX i1 ON t1(y);
} {wal}

foreach {tn sql idx} {
  1 "SELECT * FROM t1 WHERE y=50" {(50)- (60,6)}
  2 "SELECT * FROM t1 WHERE y<50" {(NULL)+ (50,5)}

  3 "SELECT * FROM t1 WHERE y>50" {(50)+ ()}
  4 "SELECT * FROM t1 WHERE y>=50" {(50)- ()}

  4 "SELECT * FROM t1 WHERE y<50 ORDER BY y DESC" {() (50)-}


  5 "SELECT * FROM t1 WHERE y>50" {(50)+ ()}

} {

  execsql "BEGIN CONCURRENT"
  execsql $sql

  set lRes [list]
  foreach {a b} $idx {
    lappend lRes 3 read $a $b
  }
    
  do_execsql_test 3.1.$tn {
    SELECT * FROM sqlite_conc WHERE op='read' 
  } $lRes


  execsql ROLLBACK
}

#-------------------------------------------------------------------------
reset_db 
do_execsql_test 5.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b UNIQUE);
  BEGIN CONCURRENT;
    INSERT INTO t1 VALUES(1, 'one');
    INSERT INTO t1 VALUES(2, 'two');
  COMMIT;
} {wal}

#-------------------------------------------------------------------------
reset_db 
do_execsql_test 6.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b);
  CREATE TABLE t2(x);
  INSERT INTO t1 VALUES
    (1, 1), (2, 1), (3, 1), (4, 1),
    (5, 2), (6, 2), (7, 2), (8, 2),
    (9, 3), (10, 3), (11, 3), (12, 3);
  CREATE INDEX i1 ON t1(b);
} {wal}

sqlite3 db2 test.db

do_execsql_test 6.1.1 {
  BEGIN CONCURRENT;
    SELECT a FROM t1 WHERE b=1;
    INSERT INTO t2 VALUES('hello');
} {1 2 3 4}

do_test 6.1.2 {
  execsql {
    BEGIN CONCURRENT;
      INSERT INTO t1 VALUES(13, 1);
    COMMIT;
  } db2
} {}

do_catchsql_test 6.1.3 {
  COMMIT
} {1 {database is locked}}
execsql ROLLBACK

do_execsql_test 6.2.1 {
  BEGIN CONCURRENT;
    SELECT count(*) FROM t1;
    INSERT INTO t2 VALUES('world');
} {13}

do_test 6.2.2 {
  execsql {
    BEGIN CONCURRENT;
      INSERT INTO t1 VALUES(14, 4);
    COMMIT;
  } db2
} {}

do_catchsql_test 6.2.3 {
  COMMIT
} {1 {database is locked}}
execsql ROLLBACK

#-------------------------------------------------------------------------
reset_db 
do_execsql_test 7.0 {
  PRAGMA journal_mode = wal;
  CREATE TABLE t1(x, y);
  CREATE TABLE t2(a INTEGER PRIMARY KEY, b);
  INSERT INTO t2 VALUES(1, 'one');
  INSERT INTO t2 VALUES(2, 'two');
  INSERT INTO t2 VALUES(3, 'three');
} {wal}

do_execsql_test 7.1.1 {
  BEGIN CONCURRENT;
    UPDATE t2 SET b='one+1' WHERE a=1;
    SAVEPOINT rb;
      INSERT INTO t1 VALUES(1, 2);
    ROLLBACK TO rb;
}

sqlite3 db2 test.db

do_test 7.1.2 {
  execsql {
    BEGIN CONCURRENT;
      UPDATE t2 SET b='three+1' WHERE a=3;
    COMMIT;
  } db2
} {}

do_execsql_test 7.1.3 {
  COMMIT;
  SELECT * FROM t1;
} {}



finish_test


