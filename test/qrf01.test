# 2025-11-05
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
#
# Test cases for the Query Result Formatter (QRF)
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix qrf01

do_execsql_test 1.0 {
  CREATE TABLE t1(a, b, c);
  INSERT INTO t1 VALUES(1,2.5,'three'),(x'424c4f42',NULL,'Ἀμήν');
}

do_test 1.10 {
  set result "\n[db format {SELECT * FROM t1}]"
} {
┌──────┬─────┬───────┐
│  a   │  b  │   c   │
├──────┼─────┼───────┤
│ 1    │ 2.5 │ three │
│ BLOB │     │ Ἀμήν  │
└──────┴─────┴───────┘
}
do_test 1.11a {
  set result "\n[db format -columnnames off {SELECT * FROM t1}]"
} {
┌──────┬─────┬───────┐
│ 1    │ 2.5 │ three │
│ BLOB │     │ Ἀμήν  │
└──────┴─────┴───────┘
}
do_test 1.11b {
  set result "\n[db format -text sql {SELECT * FROM t1}]"
} {
┌─────────────┬─────┬─────────┐
│      a      │  b  │    c    │
├─────────────┼─────┼─────────┤
│ 1           │ 2.5 │ 'three' │
│ x'424c4f42' │     │ 'Ἀμήν'  │
└─────────────┴─────┴─────────┘
}
do_test 1.12 {
  set result "\n[db format -text csv {SELECT * FROM t1}]"
} {
┌────────────────────┬─────┬────────┐
│         a          │  b  │   c    │
├────────────────────┼─────┼────────┤
│ 1                  │ 2.5 │ three  │
│ "\102\114\117\102" │     │ "Ἀμήν" │
└────────────────────┴─────┴────────┘
}
do_test 1.13 {
  set result "\n[db format -text csv -blob hex {SELECT * FROM t1}]"
} {
┌──────────┬─────┬────────┐
│    a     │  b  │   c    │
├──────────┼─────┼────────┤
│ 1        │ 2.5 │ three  │
│ 424c4f42 │     │ "Ἀμήν" │
└──────────┴─────┴────────┘
}
do_test 1.14 {
  catch {db format -text unk -blob hex {SELECT * FROM t1}} res
  set res
} {bad text encoding (-text) "unk": must be auto, csv, html, json, off, sql, or tcl}
do_test 1.15 {
  catch {db format -text sql -blob unk {SELECT * FROM t1}} res
  set res
} {bad BLOB encoding (-blob) "unk": must be auto, hex, json, tcl, text, or sql}
do_test 1.16 {
  catch {db format -text sql -style unk {SELECT * FROM t1}} res
  set res
} {bad format style (-style) "unk": must be auto, box, column, count, csv, eqp, explain, html, insert, json, json-line, line, list, markdown, quote, stats, stats-est, stats-vm, or table}

	
do_test 1.20 {
  set result "\n[db format -style box {SELECT * FROM t1}]"
} {
┌──────┬─────┬───────┐
│  a   │  b  │   c   │
├──────┼─────┼───────┤
│ 1    │ 2.5 │ three │
│ BLOB │     │ Ἀμήν  │
└──────┴─────┴───────┘
}

do_test 1.30 {
  set result "\n[db format -style table {SELECT * FROM t1}]"
} {
+------+-----+-------+
|  a   |  b  |   c   |
+------+-----+-------+
| 1    | 2.5 | three |
| BLOB |     | Ἀμήν  |
+------+-----+-------+
}
do_test 1.31 {
  set result "\n[db format -style table -columnnames off {SELECT * FROM t1}]"
} {
+------+-----+-------+
| 1    | 2.5 | three |
| BLOB |     | Ἀμήν  |
+------+-----+-------+
}

do_test 1.40 {
  set result "\n[db format -style column {SELECT * FROM t1}]"
} {
a     b    c    
----  ---  -----
1     2.5  three
BLOB       Ἀμήν 
}
do_test 1.41 {
  set result "\n[db format -style column -columnnames off {SELECT * FROM t1}]"
} {
1     2.5  three
BLOB       Ἀμήν 
}

do_test 1.50 {
  db format -style count {SELECT * FROM t1}
} 2

do_test 1.60 {
  db format -style csv {SELECT * FROM t1}
} "1,2.5,three\r\n\"\\102\\114\\117\\102\",,\"Ἀμήν\"\r\n"
do_test 1.61 {
  db format -style csv -columnnames on {SELECT * FROM t1}
} "a,b,c\r\n1,2.5,three\r\n\"\\102\\114\\117\\102\",,\"Ἀμήν\"\r\n"
do_test 1.62 {
  db format -style csv -columnnames on {SELECT a AS 'a x y', b, c FROM t1}
} "\"a x y\",b,c\r\n1,2.5,three\r\n\"\\102\\114\\117\\102\",,\"Ἀμήν\"\r\n"

do_test 1.70 {
  set result "\n[db format -style html {SELECT * FROM t1}]"
} {
<TR>
<TD>1
<TD>2.5
<TD>three
</TR>
<TR>
<TD>BLOB
<TD>null
<TD>Ἀμήν
</TR>
}
do_test 1.71 {
  set result "\n[db format -style html -columnnames on {SELECT * FROM t1}]"
} {
<TR>
<TH>a
<TH>b
<TH>c
</TR>
<TR>
<TD>1
<TD>2.5
<TD>three
</TR>
<TR>
<TD>BLOB
<TD>null
<TD>Ἀμήν
</TR>
}

do_test 1.80 {
  set result "\n[db format -style insert {SELECT * FROM t1}]"
} {
INSERT INTO tab VALUES(1,2.5,'three');
INSERT INTO tab VALUES(x'424c4f42',NULL,'Ἀμήν');
}
do_test 1.81 {
  set result "\n[db format -style insert -tablename t1 {SELECT * FROM t1}]"
} {
INSERT INTO t1 VALUES(1,2.5,'three');
INSERT INTO t1 VALUES(x'424c4f42',NULL,'Ἀμήν');
}
do_test 1.82 {
  set result "\n[db format -style insert -tablename t1 -columnnames on \
      {SELECT * FROM t1}]"
} {
INSERT INTO t1(a,b,c) VALUES(1,2.5,'three');
INSERT INTO t1(a,b,c) VALUES(x'424c4f42',NULL,'Ἀμήν');
}
do_test 1.83 {
  set result "\n[db format -style insert -tablename drop -columnnames on \
      {SELECT a AS "a-b", b, c AS "123" FROM t1}]"
} {
INSERT INTO "drop"("a-b",b,"123") VALUES(1,2.5,'three');
INSERT INTO "drop"("a-b",b,"123") VALUES(x'424c4f42',NULL,'Ἀμήν');
}

do_test 1.90 {
  set result "\n[db format -style json {SELECT * FROM t1}]"
} {
[{"a":1,"b":2.5,"c":"three"},
{"a":"\u0042\u004c\u004f\u0042","c":"Ἀμήν"}]
}
do_test 1.91 {
  set result "\n[db format -style json-line {SELECT * FROM t1}]"
} {
{"a":1,"b":2.5,"c":"three"}
{"a":"\u0042\u004c\u004f\u0042","c":"Ἀμήν"}
}
do_test 1.92 {
  set result "\n[db format -style json-line {SELECT *, unistr('abc\u000a123\u000d\u000axyz') AS xyz FROM t1}]"
} {
{"a":1,"b":2.5,"c":"three","xyz":"abc\n123\r\nxyz"}
{"a":"\u0042\u004c\u004f\u0042","c":"Ἀμήν","xyz":"abc\n123\r\nxyz"}
}

do_test 1.100 {
  set result "\n[db format -style line {SELECT * FROM t1}]"
} {
a = 1
b = 2.5
c = three

a = BLOB
b = 
c = Ἀμήν
}
do_test 1.101 {
  set result "\n[db format -style line -null (NULL) {SELECT * FROM t1}]"
} {
a = 1
b = 2.5
c = three

a = BLOB
b = (NULL)
c = Ἀμήν
}
do_test 1.102 {
  set result "\n[db format -style line -null (NULL) \
                 -text sql {SELECT * FROM t1}]"
} {
a = 1
b = 2.5
c = 'three'

a = x'424c4f42'
b = (NULL)
c = 'Ἀμήν'
}

do_test 1.110 {
  set result "\n[db format -style list {SELECT * FROM t1}]"
} {
1|2.5|three
BLOB||Ἀμήν
}
do_test 1.111 {
  set result "\n[db format -style list -columnnames on {SELECT * FROM t1}]"
} {
a|b|c
1|2.5|three
BLOB||Ἀμήν
}
do_test 1.112 {
  set result "\n[db format -style list -columnnames on -text sql -null NULL \
                 {SELECT * FROM t1}]"
} {
a|b|c
1|2.5|'three'
x'424c4f42'|NULL|'Ἀμήν'
}
do_test 1.118 {
  set rc [catch {db format -style list -columnnames unk {SELECT * FROM t1}} res]
  lappend rc $res
} {1 {bad -columnnames "unk": must be auto, off, or on}}


do_test 1.120 {
  set result "\n[db format -style markdown {SELECT * FROM t1}]"
} {
|  a   |  b  |   c   |
|------|-----|-------|
| 1    | 2.5 | three |
| BLOB |     | Ἀμήν  |
}
do_test 1.121 {
  set result "\n[db format -style markdown -columnnames off {SELECT * FROM t1}]"
} {
| 1    | 2.5 | three |
| BLOB |     | Ἀμήν  |
}

do_test 1.130 {
  set result "\n[db format -style quote {SELECT * FROM t1}]"
} {
1,2.5,'three'
x'424c4f42',NULL,'Ἀμήν'
}
do_test 1.131 {
  set result "\n[db format -style quote -columnnames on {SELECT * FROM t1}]"
} {
a,b,c
1,2.5,'three'
x'424c4f42',NULL,'Ἀμήν'
}


do_execsql_test 2.0 {
  DELETE FROM t1;
  INSERT INTO t1 VALUES(1,2,'The quick fox jumps over the lazy brown dog.');
}
do_test 2.1 {
  set result "\n[db format -widths {5 -5 19} -wordwrap on \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬─────────────────────┐
│   a   │   b   │          c          │
├───────┼───────┼─────────────────────┤
│ 1     │     2 │ The quick fox jumps │
│       │       │ over the lazy brown │
│       │       │ dog.                │
└───────┴───────┴─────────────────────┘
}
do_test 2.2 {
  set result "\n[db format -widths {5 -5 19} -wordwrap off \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬─────────────────────┐
│   a   │   b   │          c          │
├───────┼───────┼─────────────────────┤
│ 1     │     2 │ The quick fox jumps │
│       │       │ over the lazy brown │
│       │       │ dog.                │
└───────┴───────┴─────────────────────┘
}
do_test 2.3 {
  set result "\n[db format -widths {5 -5 18} -wordwrap on \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬────────────────────┐
│   a   │   b   │         c          │
├───────┼───────┼────────────────────┤
│ 1     │     2 │ The quick fox      │
│       │       │ jumps over the     │
│       │       │ lazy brown dog.    │
└───────┴───────┴────────────────────┘
}
do_test 2.4 {
  set result "\n[db format -widths {5 -5 -18} -wordwrap on \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬────────────────────┐
│   a   │   b   │         c          │
├───────┼───────┼────────────────────┤
│ 1     │     2 │      The quick fox │
│       │       │     jumps over the │
│       │       │    lazy brown dog. │
└───────┴───────┴────────────────────┘
}
do_test 2.5 {
  set result "\n[db format -widths {5 -5 18} -wordwrap off \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬─────────────────────┐
│   a   │   b   │          c          │
├───────┼───────┼─────────────────────┤
│ 1     │     2 │ The quick fox jumps │
│       │       │  over the lazy brow │
│       │       │ n dog.              │
└───────┴───────┴─────────────────────┘
}

do_execsql_test 2.10 {
  UPDATE t1 SET c='Η γρήγορη αλεπού πηδάει πάνω από το τεμπέλικο καφέ σκυλί';
}
do_test 2.11 {
  set result "\n[db format -widths {5 -5 18} -wordwrap on \
                 {SELECT * FROM t1}]"
} {
┌───────┬───────┬────────────────────┐
│   a   │   b   │         c          │
├───────┼───────┼────────────────────┤
│ 1     │     2 │ Η γρήγορη αλεπού   │
│       │       │ πηδάει πάνω από το │
│       │       │ τεμπέλικο καφέ     │
│       │       │ σκυλί              │
└───────┴───────┴────────────────────┘
}


do_execsql_test 3.0 {
  DELETE FROM t1;
  INSERT INTO t1 VALUES(1,2,unistr('abc\u001b[1;31m123\u001b[0mxyz'));
}
do_test 3.1 {
  set result "\n[db format {SELECT * FROM t1}]"
} {
┌───┬───┬────────────────────────┐
│ a │ b │           c            │
├───┼───┼────────────────────────┤
│ 1 │ 2 │ abc^[[1;31m123^[[0mxyz │
└───┴───┴────────────────────────┘
}
do_test 3.2 {
  set result "\n[db format -esc off {SELECT * FROM t1}]"
  string map [list \033 X] $result
} {
┌───┬───┬───────────┐
│ a │ b │     c     │
├───┼───┼───────────┤
│ 1 │ 2 │ abcX[1;31m123X[0mxyz │
└───┴───┴───────────┘
}
do_test 3.3 {
  set result "\n[db format -esc symbol {SELECT * FROM t1}]"
} {
┌───┬───┬──────────────────────┐
│ a │ b │          c           │
├───┼───┼──────────────────────┤
│ 1 │ 2 │ abc␛[1;31m123␛[0mxyz │
└───┴───┴──────────────────────┘
}
do_test 3.4 {
  set result "\n[db format -esc ascii {SELECT * FROM t1}]"
} {
┌───┬───┬────────────────────────┐
│ a │ b │           c            │
├───┼───┼────────────────────────┤
│ 1 │ 2 │ abc^[[1;31m123^[[0mxyz │
└───┴───┴────────────────────────┘
}
do_test 3.5 {
  catch {db format -esc unk {SELECT * FROM t1}} res
  set res
} {bad control character escape (-esc) "unk": must be ascii, auto, off, or symbol}

do_execsql_test 4.0 {
  DELETE FROM t1;
  INSERT INTO t1 VALUES(json('{a:5,b:6}'), jsonb('{c:1,d:2}'), 99);
}
do_test 4.1 {
  set result "\n[db format -text sql {SELECT * FROM t1}]"
} {
┌─────────────────┬───────────────────────┬────┐
│        a        │           b           │ c  │
├─────────────────┼───────────────────────┼────┤
│ '{"a":5,"b":6}' │ x'8c1763133117641332' │ 99 │
└─────────────────┴───────────────────────┴────┘
}
do_test 4.2 {
  set result "\n[db format -text sql -textjsonb on {SELECT * FROM t1}]"
} {
┌─────────────────┬─────────────────┬────┐
│        a        │        b        │ c  │
├─────────────────┼─────────────────┼────┤
│ '{"a":5,"b":6}' │ '{"c":1,"d":2}' │ 99 │
└─────────────────┴─────────────────┴────┘
}
do_test 4.3 {
  set result "\n[db format -text off -textjsonb on -maxcolwidth 10 \
              {SELECT a AS json, b AS jsonb, c AS num FROM t1}]"
} {
┌─────────────┬─────────────┬─────┐
│    json     │    jsonb    │ num │
├─────────────┼─────────────┼─────┤
│ {"a":5,"b": │ {"c":1,"d": │ 99  │
│ 6}          │ 2}          │     │
└─────────────┴─────────────┴─────┘
}


finish_test
